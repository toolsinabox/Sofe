<!-- Checkout Page Template -->
<style>
    .checkout-page {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 2rem 0;
    }
    .checkout-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
    }
    @media (max-width: 968px) {
        .checkout-container {
            grid-template-columns: 1fr;
        }
    }
    .checkout-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .checkout-section h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111;
        margin: 0 0 1.25rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f0f0f0;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .form-row.single {
        grid-template-columns: 1fr;
    }
    @media (max-width: 600px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    .form-group {
        display: flex;
        flex-direction: column;
    }
    .form-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    .form-group label .required {
        color: #dc2626;
    }
    .form-group input, .form-group select, .form-group textarea {
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #2563eb;
    }
    .checkbox-group label {
        font-size: 0.9rem;
        color: #555;
        cursor: pointer;
    }
    
    /* Payment Methods */
    .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .payment-option, .shipping-option {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .payment-option:hover, .shipping-option:hover {
        border-color: #2563eb;
        background: #f8faff;
    }
    .payment-option.selected, .shipping-option.selected {
        border-color: #2563eb;
        background: #eff6ff;
    }
    .shipping-option {
        margin-bottom: 0.75rem;
    }
    .shipping-option-info {
        flex: 1;
    }
    .shipping-option-info h4 {
        font-weight: 600;
        margin: 0;
        font-size: 0.95rem;
    }
    .shipping-option-info p {
        font-size: 0.8rem;
        color: #666;
        margin: 0.25rem 0 0 0;
    }
    .shipping-option-price {
        font-weight: 700;
        font-size: 1rem;
        color: #c41e3a;
    }
    .shipping-option-price.free {
        color: #16a34a;
    }
    .shipping-option input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #2563eb;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        accent-color: #2563eb;
    }
    .payment-option-info {
        flex: 1;
    }
    .payment-option-info h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #111;
        margin: 0 0 0.25rem 0;
    }
    .payment-option-info p {
        font-size: 0.85rem;
        color: #666;
        margin: 0;
    }
    .payment-icons {
        display: flex;
        gap: 0.5rem;
    }
    .payment-icons img {
        height: 24px;
    }
    
    /* Stripe Card Element */
    #card-element {
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        margin-top: 1rem;
        background: #fafafa;
    }
    #card-errors {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Order Summary */
    .order-summary {
        position: sticky;
        top: 2rem;
    }
    .order-items {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }
    .order-item {
        display: flex;
        gap: 1rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .order-item:last-child {
        border-bottom: none;
    }
    .order-item-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        background: #f5f5f5;
    }
    .order-item-details {
        flex: 1;
    }
    .order-item-name {
        font-weight: 600;
        color: #111;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }
    .order-item-qty {
        font-size: 0.85rem;
        color: #666;
    }
    .order-item-price {
        font-weight: 600;
        color: #111;
    }
    
    .summary-line {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        font-size: 0.95rem;
    }
    .summary-line.total {
        font-size: 1.25rem;
        font-weight: 700;
        border-top: 2px solid #111;
        padding-top: 1rem;
        margin-top: 0.5rem;
    }
    .summary-line .label {
        color: #666;
    }
    .summary-line.total .label {
        color: #111;
    }
    
    /* Place Order Button */
    .place-order-btn {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 1rem;
    }
    .place-order-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .place-order-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .place-order-btn.loading {
        position: relative;
        color: transparent;
    }
    .place-order-btn.loading::after {
        content: "";
        position: absolute;
        width: 24px;
        height: 24px;
        top: 50%;
        left: 50%;
        margin: -12px 0 0 -12px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Secure Badge */
    .secure-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
        color: #666;
        font-size: 0.85rem;
    }
    .secure-badge svg {
        width: 16px;
        height: 16px;
        color: #22c55e;
    }
    
    /* Success Modal */
    .success-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }
    .success-modal.active {
        display: flex;
    }
    .success-modal-content {
        background: white;
        border-radius: 16px;
        padding: 3rem;
        max-width: 450px;
        text-align: center;
        animation: modalSlide 0.3s ease;
    }
    @keyframes modalSlide {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .success-icon {
        width: 80px;
        height: 80px;
        background: #22c55e;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }
    .success-icon svg {
        width: 40px;
        height: 40px;
        color: white;
    }
    .success-modal h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111;
        margin: 0 0 0.5rem 0;
    }
    .success-modal p {
        color: #666;
        margin-bottom: 1.5rem;
    }
    .order-number-display {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 8px;
        font-family: monospace;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    .continue-btn {
        padding: 0.75rem 2rem;
        background: #111;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }
</style>

<div class="checkout-page">
    <div class="checkout-container">
        <!-- Left Column - Forms -->
        <div class="checkout-forms">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem;">Checkout</h1>
            
            <form id="checkout-form" onsubmit="processCheckout(event)">
                <!-- Contact Information -->
                <div class="checkout-section">
                    <h2>Contact Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name <span class="required">*</span></label>
                            <input type="text" id="customer_name" name="customer_name" required placeholder="John Smith">
                        </div>
                        <div class="form-group">
                            <label>Email <span class="required">*</span></label>
                            <input type="email" id="customer_email" name="customer_email" required placeholder="john@example.com">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="customer_phone" name="customer_phone" placeholder="0400 000 000">
                        </div>
                        <div class="form-group">
                            <label>Company (optional)</label>
                            <input type="text" id="company_name" name="company_name" placeholder="Company Pty Ltd">
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Address -->
                <div class="checkout-section">
                    <h2>Shipping Address</h2>
                    <div class="form-row single">
                        <div class="form-group">
                            <label>Street Address <span class="required">*</span></label>
                            <input type="text" id="shipping_address" name="shipping_address" required placeholder="123 Main Street">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City <span class="required">*</span></label>
                            <input type="text" id="shipping_city" name="shipping_city" required placeholder="Melbourne">
                        </div>
                        <div class="form-group">
                            <label>State <span class="required">*</span></label>
                            <select id="shipping_state" name="shipping_state" required>
                                <option value="">Select State</option>
                                <option value="VIC">Victoria</option>
                                <option value="NSW">New South Wales</option>
                                <option value="QLD">Queensland</option>
                                <option value="WA">Western Australia</option>
                                <option value="SA">South Australia</option>
                                <option value="TAS">Tasmania</option>
                                <option value="NT">Northern Territory</option>
                                <option value="ACT">Australian Capital Territory</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Postcode <span class="required">*</span></label>
                            <input type="text" id="shipping_postcode" name="shipping_postcode" required placeholder="3000">
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <select id="shipping_country" name="shipping_country">
                                <option value="AU" selected>Australia</option>
                                <option value="NZ">New Zealand</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Method Selection -->
                <div class="checkout-section">
                    <h2>Shipping Method <span class="required">*</span></h2>
                    <p id="shipping-instruction" style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                        Enter your postcode above to see available shipping options.
                    </p>
                    <div id="shipping-options-loading" style="display: none; padding: 1rem; text-align: center;">
                        <div class="spinner" style="display: inline-block; width: 24px; height: 24px; border: 2px solid #ddd; border-top-color: #c41e3a; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="margin-left: 0.5rem;">Calculating shipping options...</span>
                    </div>
                    <div id="shipping-options-container" style="display: none;">
                        <!-- Pickup Option -->
                        <label class="shipping-option" data-shipping-method="pickup" data-shipping-price="0">
                            <input type="radio" name="shipping_method" value="pickup" onchange="selectShippingMethod(this)">
                            <div class="shipping-option-info">
                                <h4>Pickup - In Store</h4>
                                <p>Pick up from our warehouse</p>
                            </div>
                            <div class="shipping-option-price">FREE</div>
                        </label>
                        <!-- Calculated Shipping Options -->
                        <div id="calculated-shipping-options"></div>
                    </div>
                    <div id="no-shipping-available" style="display: none; padding: 1rem; background: #fff3cd; border-radius: 8px; color: #856404;">
                        <svg viewBox="0 0 20 20" fill="currentColor" width="16" height="16" style="vertical-align: middle; margin-right: 0.5rem;"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                        No shipping options available for this location. Please select Pickup or enter a different postcode.
                    </div>
                    <p id="shipping-required-error" style="display: none; color: #dc2626; font-size: 0.85rem; margin-top: 0.5rem;">
                        ‚ö†Ô∏è Please select a shipping method to continue.
                    </p>
                </div>
                
                <!-- Billing Address -->
                <div class="checkout-section">
                    <h2>Billing Address</h2>
                    <div class="checkbox-group">
                        <input type="checkbox" id="billing_same" name="billing_same" checked onchange="toggleBillingAddress()">
                        <label for="billing_same">Same as shipping address</label>
                    </div>
                    <div id="billing-fields" style="display: none;">
                        <div class="form-row single">
                            <div class="form-group">
                                <label>Street Address</label>
                                <input type="text" id="billing_address" name="billing_address" placeholder="123 Main Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="billing_city" name="billing_city" placeholder="Melbourne">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <select id="billing_state" name="billing_state">
                                    <option value="">Select State</option>
                                    <option value="VIC">Victoria</option>
                                    <option value="NSW">New South Wales</option>
                                    <option value="QLD">Queensland</option>
                                    <option value="WA">Western Australia</option>
                                    <option value="SA">South Australia</option>
                                    <option value="TAS">Tasmania</option>
                                    <option value="NT">Northern Territory</option>
                                    <option value="ACT">Australian Capital Territory</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Postcode</label>
                                <input type="text" id="billing_postcode" name="billing_postcode" placeholder="3000">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="billing_country" name="billing_country">
                                    <option value="AU" selected>Australia</option>
                                    <option value="NZ">New Zealand</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method -->
                <div class="checkout-section">
                    <h2>Payment Method</h2>
                    <div class="payment-methods">
                        <label class="payment-option selected" onclick="selectPayment('card')">
                            <input type="radio" name="payment_method" value="card" checked>
                            <div class="payment-option-info">
                                <h4>Credit / Debit Card</h4>
                                <p>Pay securely with your card</p>
                            </div>
                            <div class="payment-icons">
                                <span style="font-size: 1.5rem;">üí≥</span>
                            </div>
                        </label>
                        
                        <label class="payment-option" onclick="selectPayment('bank_transfer')">
                            <input type="radio" name="payment_method" value="bank_transfer">
                            <div class="payment-option-info">
                                <h4>Bank Transfer</h4>
                                <p>Pay via direct bank transfer</p>
                            </div>
                            <div class="payment-icons">
                                <span style="font-size: 1.5rem;">üè¶</span>
                            </div>
                        </label>
                        
                        <label class="payment-option" onclick="selectPayment('pay_later')">
                            <input type="radio" name="payment_method" value="pay_later">
                            <div class="payment-option-info">
                                <h4>Pay on Invoice</h4>
                                <p>Receive invoice and pay later</p>
                            </div>
                            <div class="payment-icons">
                                <span style="font-size: 1.5rem;">üìÑ</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Card Payment Fields -->
                    <div id="card-payment-section">
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert"></div>
                    </div>
                    
                    <!-- Bank Transfer Info -->
                    <div id="bank-transfer-section" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600;">Bank Details:</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #555;">
                            BSB: 000-000<br>
                            Account: 12345678<br>
                            Account Name: Tools in a Box Pty Ltd<br>
                            Reference: Your order number
                        </p>
                    </div>
                </div>
                
                <!-- Order Notes -->
                <div class="checkout-section">
                    <h2>Order Notes (optional)</h2>
                    <div class="form-group">
                        <textarea id="order_notes" name="order_notes" rows="3" placeholder="Any special instructions for your order..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Purchase Order Number (optional)</label>
                        <input type="text" id="purchase_order" name="purchase_order" placeholder="PO-12345">
                    </div>
                </div>
                
                <button type="submit" class="place-order-btn" id="place-order-btn">
                    Place Order
                </button>
            </form>
        </div>
        
        <!-- Right Column - Order Summary -->
        <div class="order-summary-wrapper">
            <div class="checkout-section order-summary">
                <h2>Order Summary</h2>
                <div class="order-items" id="checkout-items">
                    <!-- Items loaded via JS -->
                    <p style="color: #666; text-align: center; padding: 2rem;">Loading cart...</p>
                </div>
                
                <div class="summary-totals">
                    <div class="summary-line">
                        <span class="label">Subtotal</span>
                        <span id="checkout-subtotal">$0.00</span>
                    </div>
                    <div class="summary-line">
                        <span class="label">Shipping</span>
                        <span id="checkout-shipping">$0.00</span>
                    </div>
                    <div class="summary-line">
                        <span class="label">GST (10%)</span>
                        <span id="checkout-tax">$0.00</span>
                    </div>
                    <div class="summary-line total">
                        <span class="label">Total</span>
                        <span id="checkout-total">$0.00</span>
                    </div>
                </div>
                
                <div class="secure-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <span>Secure checkout - SSL encrypted</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="success-modal" id="success-modal">
    <div class="success-modal-content">
        <div class="success-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        <h2>Order Placed Successfully!</h2>
        <p>Thank you for your order. You will receive a confirmation email shortly.</p>
        <div class="order-number-display" id="order-number-display">
            ORD-XXXXXXXX
        </div>
        <button class="continue-btn" onclick="window.location.href='/live'">Continue Shopping</button>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const API_BASE = window.location.origin + '/api';
let cartData = null;
let stripe = null;
let cardElement = null;
let selectedPaymentMethod = 'card';
let shippingCost = 0;

// Initialize Stripe
async function initStripe() {
    try {
        // Use test publishable key
        stripe = Stripe('pk_test_emergent');
        const elements = stripe.elements();
        cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#333',
                    '::placeholder': { color: '#aab7c4' }
                }
            }
        });
        cardElement.mount('#card-element');
        
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
    } catch (e) {
        console.log('Stripe initialization skipped:', e);
    }
}

// Load cart data
let selectedShippingMethod = null;

async function loadCheckoutCart() {
    const cartId = localStorage.getItem('tiab_cart_id');
    if (!cartId) {
        document.getElementById('checkout-items').innerHTML = '<p style="text-align: center; color: #666;">Your cart is empty</p>';
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/cart/${cartId}`);
        if (!response.ok) throw new Error('Failed to load cart');
        
        cartData = await response.json();
        
        if (!cartData.items || cartData.items.length === 0) {
            document.getElementById('checkout-items').innerHTML = '<p style="text-align: center; color: #666;">Your cart is empty</p>';
            return;
        }
        
        renderCheckoutItems();
        updateCheckoutTotals();
        
        // Check for saved shipping
        const savedShipping = localStorage.getItem('tiab_selected_shipping');
        if (savedShipping) {
            const shipping = JSON.parse(savedShipping);
            shippingCost = shipping.rate?.price || 0;
            selectedShippingMethod = shipping.rate?.method || 'delivery';
        }
        updateCheckoutTotals();
        
    } catch (error) {
        console.error('Error loading cart:', error);
    }
}

// Shipping calculation functions
let postcodeDebounceTimer = null;

function initShippingCalculator() {
    const postcodeInput = document.getElementById('shipping_postcode');
    if (postcodeInput) {
        postcodeInput.addEventListener('input', function() {
            if (postcodeDebounceTimer) clearTimeout(postcodeDebounceTimer);
            postcodeDebounceTimer = setTimeout(() => {
                if (this.value.length === 4) {
                    calculateCheckoutShipping();
                } else {
                    resetShippingOptions();
                }
            }, 500);
        });
    }
}

function resetShippingOptions() {
    document.getElementById('shipping-instruction').style.display = 'block';
    document.getElementById('shipping-options-loading').style.display = 'none';
    document.getElementById('shipping-options-container').style.display = 'none';
    document.getElementById('no-shipping-available').style.display = 'none';
    document.getElementById('shipping-required-error').style.display = 'none';
    selectedShippingMethod = null;
    shippingCost = 0;
    updateCheckoutTotals();
}

async function calculateCheckoutShipping() {
    const postcode = document.getElementById('shipping_postcode').value.trim();
    if (postcode.length !== 4 || !cartData || !cartData.items || cartData.items.length === 0) {
        return;
    }
    
    const instruction = document.getElementById('shipping-instruction');
    const loading = document.getElementById('shipping-options-loading');
    const container = document.getElementById('shipping-options-container');
    const calculatedOptions = document.getElementById('calculated-shipping-options');
    const noShipping = document.getElementById('no-shipping-available');
    
    instruction.style.display = 'none';
    loading.style.display = 'block';
    container.style.display = 'none';
    noShipping.style.display = 'none';
    
    try {
        // Build items array for API
        const items = cartData.items.map(item => ({
            weight: item.weight || 0.5,
            quantity: item.quantity,
            shipping_length: item.shipping_length || 0,
            shipping_width: item.shipping_width || 0,
            shipping_height: item.shipping_height || 0
        }));
        
        const cartTotal = cartData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        const response = await fetch(`${API_BASE}/shipping/calculate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                postcode: postcode,
                suburb: document.getElementById('shipping_city')?.value || null,
                country: 'AU',
                items: items,
                cart_total: cartTotal
            })
        });
        
        if (!response.ok) throw new Error('Failed to calculate shipping');
        
        const data = await response.json();
        const options = data.options || [];
        
        loading.style.display = 'none';
        container.style.display = 'block';
        
        if (options.length === 0) {
            calculatedOptions.innerHTML = '';
            noShipping.style.display = 'block';
        } else {
            noShipping.style.display = 'none';
            calculatedOptions.innerHTML = options.map(opt => `
                <label class="shipping-option" data-shipping-method="${opt.method || 'delivery'}" data-shipping-price="${opt.price}">
                    <input type="radio" name="shipping_method" value="${opt.name}" onchange="selectShippingMethod(this)">
                    <div class="shipping-option-info">
                        <h4>${opt.name}</h4>
                        <p>${opt.description || ''}</p>
                    </div>
                    <div class="shipping-option-price ${opt.price === 0 ? 'free' : ''}">
                        ${opt.price === 0 ? 'FREE' : '$' + opt.price.toFixed(2)}
                        ${opt.gst_amount > 0 ? '<span style="font-size:0.75rem;color:#888;display:block;">' + (opt.tax_inclusive ? 'incl. GST' : '+ GST') + '</span>' : ''}
                    </div>
                </label>
            `).join('');
        }
        
    } catch (error) {
        console.error('Error calculating shipping:', error);
        loading.style.display = 'none';
        container.style.display = 'block';
        noShipping.style.display = 'block';
    }
}

function selectShippingMethod(radio) {
    const option = radio.closest('.shipping-option');
    const price = parseFloat(option.dataset.shippingPrice) || 0;
    const method = option.dataset.shippingMethod || 'delivery';
    
    // Update UI
    document.querySelectorAll('.shipping-option').forEach(opt => opt.classList.remove('selected'));
    option.classList.add('selected');
    
    // Update state
    selectedShippingMethod = method;
    shippingCost = price;
    
    // Hide error
    document.getElementById('shipping-required-error').style.display = 'none';
    
    // Save to localStorage
    localStorage.setItem('tiab_selected_shipping', JSON.stringify({
        rate: { price: price, method: method, name: radio.value }
    }));
    
    updateCheckoutTotals();
}

function renderCheckoutItems() {
    const container = document.getElementById('checkout-items');
    
    if (!cartData || !cartData.items || cartData.items.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Your cart is empty</p>';
        return;
    }
    
    container.innerHTML = cartData.items.map(item => `
        <div class="order-item">
            <img src="${item.image || '/api/placeholder/60/60'}" alt="${item.name}" class="order-item-image">
            <div class="order-item-details">
                <div class="order-item-name">${item.name}</div>
                <div class="order-item-qty">Qty: ${item.quantity}</div>
            </div>
            <div class="order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
        </div>
    `).join('');
}

function updateCheckoutTotals() {
    if (!cartData) return;
    
    const subtotal = cartData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = (subtotal + shippingCost) * 0.1; // 10% GST
    const total = subtotal + shippingCost + tax;
    
    document.getElementById('checkout-subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('checkout-shipping').textContent = shippingCost > 0 ? '$' + shippingCost.toFixed(2) : 'FREE';
    document.getElementById('checkout-tax').textContent = '$' + tax.toFixed(2);
    document.getElementById('checkout-total').textContent = '$' + total.toFixed(2);
}

function toggleBillingAddress() {
    const billingFields = document.getElementById('billing-fields');
    const checkbox = document.getElementById('billing_same');
    billingFields.style.display = checkbox.checked ? 'none' : 'block';
}

function selectPayment(method) {
    selectedPaymentMethod = method;
    
    // Update UI
    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    // Show/hide sections
    document.getElementById('card-payment-section').style.display = method === 'card' ? 'block' : 'none';
    document.getElementById('bank-transfer-section').style.display = method === 'bank_transfer' ? 'block' : 'none';
    
    // Update button text
    const btn = document.getElementById('place-order-btn');
    if (method === 'card') {
        btn.textContent = 'Pay & Place Order';
    } else if (method === 'bank_transfer') {
        btn.textContent = 'Place Order (Pay by Bank Transfer)';
    } else {
        btn.textContent = 'Place Order (Pay on Invoice)';
    }
}

async function processCheckout(event) {
    event.preventDefault();
    
    const btn = document.getElementById('place-order-btn');
    
    // Validate shipping method is selected
    const shippingSelected = document.querySelector('input[name="shipping_method"]:checked');
    if (!shippingSelected) {
        document.getElementById('shipping-required-error').style.display = 'block';
        // Scroll to shipping section
        document.querySelector('h2:has(~ #shipping-options-container)')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    btn.disabled = true;
    btn.classList.add('loading');
    
    try {
        const cartId = localStorage.getItem('tiab_cart_id');
        if (!cartId || !cartData || !cartData.items || cartData.items.length === 0) {
            throw new Error('Your cart is empty');
        }
        
        const formData = {
            customer_name: document.getElementById('customer_name').value,
            customer_email: document.getElementById('customer_email').value,
            customer_phone: document.getElementById('customer_phone').value,
            company_name: document.getElementById('company_name').value,
            shipping_address: document.getElementById('shipping_address').value,
            shipping_city: document.getElementById('shipping_city').value,
            shipping_state: document.getElementById('shipping_state').value,
            shipping_postcode: document.getElementById('shipping_postcode').value,
            shipping_country: document.getElementById('shipping_country').value,
            billing_same_as_shipping: document.getElementById('billing_same').checked,
            billing_address: document.getElementById('billing_address').value,
            billing_city: document.getElementById('billing_city').value,
            billing_state: document.getElementById('billing_state').value,
            billing_postcode: document.getElementById('billing_postcode').value,
            billing_country: document.getElementById('billing_country').value,
            cart_id: cartId,
            shipping_cost: shippingCost,
            shipping_method: shippingSelected.value,
            payment_method: selectedPaymentMethod,
            notes: document.getElementById('order_notes').value,
            purchase_order: document.getElementById('purchase_order').value
        };
        
        // Process order
        const response = await fetch(`${API_BASE}/checkout/process`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.detail || 'Checkout failed');
        }
        
        // Clear cart from localStorage
        localStorage.removeItem('tiab_cart_id');
        localStorage.removeItem('tiab_cart_backup');
        localStorage.removeItem('tiab_selected_shipping');
        
        // Show success modal
        document.getElementById('order-number-display').textContent = result.order_number;
        document.getElementById('success-modal').classList.add('active');
        
    } catch (error) {
        console.error('Checkout error:', error);
        alert(error.message || 'Checkout failed. Please try again.');
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadCheckoutCart();
    initStripe();
});
</script>
