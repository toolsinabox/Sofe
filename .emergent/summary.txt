<analysis>**original_problem_statement:**
The user wants to build a Maropost e-commerce clone. The current focus is on perfecting the shipping calculation system and integrating it into the customer-facing storefront.

Recent requests include:
1.  **Shipping Calculation Accuracy:** Debug and fix discrepancies in shipping prices for specific products (, ) to match Maropost's logic precisely. This involves handling cubic weight, per-parcel charges, fuel levies, and minimum charges correctly.
2.  **Display All Shipping Options:** Ensure all available shipping carriers (e.g., Startrack, XFM-RES) appear as options for the customer during checkout.
3.  **UI Bug Fix:** Resolve an issue where input fields lose focus in the Edit Shipping Service modal in the merchant dashboard, making it difficult to edit rates.
4.  **UI/UX Improvements:**
    *   Change product dimension units from  to  on the merchant product page.
    *   Display the calculated cubic size next to the dimension fields.
5.  **Rate Import Reliability:** Ensure that uploading a shipping rate CSV file works correctly every time, applying all fields like Minimum Charge and Maximum Length.
6.  **Maximum Length Filtering:** Implement filtering to hide shipping options if a product's dimension exceeds the Maximum Length specified in the rate (in mm).

**User's preferred language**: English

**what currently exists?**
- A full-stack application with a React/FastAPI/MongoDB stack.
- The storefront is **not** a React SPA but is server-side rendered by a Maropost-style template engine located in . Client-side interactivity is handled by vanilla JavaScript in the theme files.
- The React components under  are legacy and **not used**.
- A complex backend shipping calculation engine in  that now handles per-parcel logic, multiple carriers, case-insensitive zone matching, minimum charges, and maximum length filtering.
- The shipping calculator is integrated into the product, cart, and checkout pages of the server-rendered storefront.
- The agent has successfully implemented logic that results in the correct price for product  (08.62 with XFM-RES).

**Last working item**:
-   **Last item agent was working:** The agent was addressing three user requests simultaneously:
    1.  Fixing the focus loss bug in the Edit Shipping Service modal ().
    2.  Implementing the change from  to  for dimensions and showing cubic size on the product page.
    3.  Verifying the shipping price for product  is correct (08.62).
    
    The agent identified the cause of the focus loss (inline  handlers creating new function references on each render) and was planning the fix. The agent was also examining the product edit page () and the service edit modal () to implement the other changes.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N (Testing was in progress for individual pieces, but not for the complete set of fixes).
-   **Which testing method agent to use?**
    1.  **Frontend testing agent** for the focus loss bug in the  form.
    2.  **Screenshot tool** to verify the UI changes (mm units, cubic size display) on the merchant product page.
    3.   or  to verify the backend calculation for  remains correct.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Incorrect Shipping Price for  (P0)**
-   **Issue 2: Focus Loss in Edit Shipping Service Modal (P0)**
-   **Issue 3: Product Data Mismatch (P2)**
-   **Issue 4: No Backend Negative Stock Validation (P2)**

Issues Detail:
-   **Issue 1: Incorrect Shipping Price for **
    -   **Attempted fixes:** The agent correctly implemented the Minimum Charge logic, but this resulted in a price of  for CCM-007, while the user expects . The agent has deduced that the per-kg rate being applied ( from  zone) is wrong and should be closer to . This points to a fundamental zone mapping issue.
    -   **Next debug checklist:**
        1.  Confirm with the user which XFM zone postcode  (Casula) should belong to, as it's likely not  for this carrier's rate card.
        2.  Investigate the zone mapping logic in  () to ensure it correctly assigns postcodes to carrier-specific zones.
        3.  Adjust the zone data or mapping logic to ensure  gets the rate that results in the  price.
    -   **Why fix this issue and what will be achieved with this?** The shipping calculation must be 100% accurate for the platform to be viable. This is a critical business logic bug.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend (via  or ) and Frontend (via  on the product page).
    -   **Blocked on other issue:** User input required to clarify the correct zone mapping for postcode 2170.
-   **Issue 2: Focus Loss in Edit Shipping Service Modal**
    -   **Attempted fixes:** The agent identified the root cause: inline  handlers () in  are creating new functions on every render, causing React to unmount and remount the input fields, which makes them lose focus.
    -   **Next debug checklist:**
        1.  Refactor the  handlers in the Edit Shipping Service modal within .
        2.  Create stable event handler functions using  or by defining them outside the JSX.
        3.  Pass these stable functions to the  prop of the input components.
    -   **Why fix this issue and what will be achieved with this?** This is a significant usability bug that prevents merchants from easily managing their shipping rates.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend testing agent.
-   **Issue 3: Product Data Mismatch**
    -   **Status:** NOT STARTED
-   **Issue 4: No Backend Negative Stock Validation**
    -   **Status:** NOT STARTED

**In progress Task List**:
-   **Task 1: Change Product Dimensions to MM and Display Cubic Size (P0)**
    -   **Where to resume:**
        1.  Modify  to change the labels for , , and  from cm to mm for both product and shipping dimensions.
        2.  In the same file, add a non-editable field or text element that displays the calculated cubic size () whenever the dimensions are changed.
        3.  Ensure the values are still sent to the backend in  or update the backend to handle , as the current calculation logic in  expects . The user's request implies a UI-only change.
    -   **What will be achieved with this?** Fulfills a direct user request for better usability and clarity on the product editing page.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Frontend

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P1:** Implement Park Sale and Void Sale functionalities in the POS.
    -   **P1:** Implement the logic for Pay Later and Layby transactions.
-   **Future Tasks:**
    -   **P2:** Add Privacy Policy and Terms of Service CMS pages.
    -   **P2:** Ensure all footer links in the storefront are functional.
    -   **P2:** Implement POS offline sync capability.

**Completed work in this session**
-   **Feature: Storefront Shipping Integration:** The shipping calculator is now fully integrated into the server-side rendered , , and  templates.
-   **Feature: Multi-Carrier Support:** The system can now show rates from multiple carriers (e.g., Startrack, XFM-RES) for a single postcode by looking up all matching zones.
-   **Feature: Advanced Rate Rules:**
    -   Implemented Minimum Charge logic for shipping rates.
    -   Implemented Maximum Length filtering (in mm) to exclude services for oversized products.
-   **Bug Fix: Per-Parcel Calculation:** Corrected the shipping logic to multiply the final calculated price per parcel, matching user expectations for multiple quantities.
-   **Bug Fix: Zone Matching:** Made the zone code lookup case-insensitive, fixing an issue where  rates weren't matching the  zone.
-   **Bug Fix: Data Persistence:** Fixed a bug where a previously tested flat fuel levy amount () was incorrectly saved in the database, skewing calculations.
-   **Bug Fix: Cart & Checkout UI:** Added a suburb selector to the cart page and fixed various JS bugs related to variable scope (, ).
-   **Bug Fix: Template Rendering:** Fixed a critical bug where shipping dimensions were not being rendered into the product page template by updating .
-   **Tooling: Rate Import:** Improved the CSV rate import logic to handle  and .

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Linting Errors in **: This file is over 3000 lines. The current focus-loss bug is a direct consequence of its complexity and technical debt. A full refactor into smaller components is still recommended for long-term stability.

**Known issue recurrence from previous fork**
-   **Product Data Mismatch**: Remains pending.
-   **No Backend Negative Stock Validation**: Remains pending.

**Code Architecture**


**Key Technical Concepts**
-   **Server-Side Templates:** The storefront UI is rendered by a backend template engine (), not React. All UI/JS changes for the store must be made in the theme files under .
-   **Complex Shipping Logic:** The calculation now incorporates: . It also handles multiple carrier zones per postcode.
-   **React State Management Bug:** The focus loss issue is a classic React problem caused by re-creating functions/components on each render, which breaks the state of uncontrolled inputs.

**key DB schema**
-   **shipping_services (collection)**
    -   : Added , .

**changes in tech stack**
-   None.

**All files of reference**
-   : The heart of the shipping calculation logic.
-   : Location of the focus-loss bug.
-   : Needs UI changes for mm units and cubic size.
-   : Product page template.
-   : Cart page template.
-   : Checkout page template.
-   : Renders product data into the HTML templates.

**Areas that need refactoring**
-   **/app/frontend/src/pages/merchant/MerchantShipping.jsx**: This file is the primary source of UI bugs and is difficult to maintain. It urgently needs to be broken down into smaller, manageable components to prevent future issues. The current focus-loss bug is a clear symptom of this technical debt.

**key api endpoints**
-   : Main calculation endpoint.
-   : For uploading CSV rate files.
-   : To update a shipping service.

**Critical Info for New Agent**
-   **PRIORITY 1: Solve the CCM-007 Price Discrepancy.** The user expects , but the calculation yields . This is a zone mapping problem. You must confirm with the user which XFM rate zone postcode  should map to, as  is incorrect for this product's expected price.
-   **PRIORITY 2: Fix the Focus Loss Bug.** This is a critical usability issue for the merchant. The root cause is identified (inline  handlers in ); you need to implement the fix by creating stable handler functions.
-   **PRIORITY 3: Implement UI Changes.** Address the user's request to change dimension units to  and display cubic size on the merchant product page.
-   **STOREFRONT IS NOT REACT:** Do not attempt to modify storefront UI by editing files in . All storefront changes must be done in the backend theme templates at .

**documents and test_reports created in this job**
-   None.

**Last 10 User Messages and any pending HUMAN messages**
-   
-   
-   
-   
-   
-   
-   
-   
-   
-   

**Project Health Check:**
-   **Broken:** The shipping price for certain products () is incorrect due to a zone mapping issue, making the checkout flow unreliable. The merchant dashboard has a critical usability bug (focus loss) that hinders rate management.
-   **Mocked:** None.

**3rd Party Integrations**
-   Stripe (Payments)

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   **Merchant Role:**
    -   **Username:** 
    -   **Password:** 

**What agent forgot to execute**
-   The agent identified the cause of the focus-loss bug but has not yet implemented the fix.
-   The agent has not started the work to change units from  to  and display cubic size.
-   The core business logic issue of why product 's shipping is miscalculated remains unresolved and blocked on user feedback about zone mapping.</analysis>
