# =============================================================================
# Celora Nginx Configuration for VPS
# Handles: Main domain, Subdomains, Custom Domains, /cpanel routing
# =============================================================================
# Replace: /etc/nginx/sites-available/celora
# Reload: sudo nginx -t && sudo systemctl reload nginx
# =============================================================================

# Upstream for FastAPI backend
upstream celora_backend {
    server 127.0.0.1:8001;
}

# =============================================================================
# SERVER BLOCK 1: Main Platform (www.getcelora.com / getcelora.com)
# =============================================================================
server {
    listen 80;
    server_name getcelora.com www.getcelora.com;
    
    # For SSL (uncomment after certbot setup):
    # listen 443 ssl;
    # ssl_certificate /etc/letsencrypt/live/getcelora.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/getcelora.com/privkey.pem;
    
    root /var/www/celora/frontend/build;
    index index.html;
    
    # API routes to backend
    location /api/ {
        proxy_pass http://celora_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Uploaded files (logos, product images, etc.)
    location /api/uploads/ {
        proxy_pass http://celora_backend;
    }
    
    # React app - SPA routing
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# =============================================================================
# SERVER BLOCK 2: Subdomains (*.getcelora.com)
# Handles: storename.getcelora.com - store storefronts
#          storename.getcelora.com/cpanel - merchant control panel
# =============================================================================
server {
    listen 80;
    server_name *.getcelora.com;
    
    # For SSL wildcard (requires DNS challenge):
    # listen 443 ssl;
    # ssl_certificate /etc/letsencrypt/live/getcelora.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/getcelora.com/privkey.pem;
    
    root /var/www/celora/frontend/build;
    index index.html;
    
    # Extract subdomain
    set $subdomain "";
    if ($host ~* ^([^.]+)\.getcelora\.com$) {
        set $subdomain $1;
    }
    
    # =========================================================================
    # /cpanel ROUTE - Serve React app for merchant control panel
    # =========================================================================
    location /cpanel {
        # Serve React app for /cpanel routes
        try_files $uri $uri/ /index.html;
    }
    
    # API routes to backend (with subdomain header)
    location /api/ {
        proxy_pass http://celora_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Subdomain $subdomain;
    }
    
    # Uploaded files
    location /api/uploads/ {
        proxy_pass http://celora_backend;
    }
    
    # =========================================================================
    # STOREFRONT - Theme-rendered store pages via backend
    # =========================================================================
    location / {
        # First try static files, then proxy to backend for storefront rendering
        proxy_pass http://celora_backend/api/maropost/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Subdomain $subdomain;
        
        # Error handling for non-existent stores
        proxy_intercept_errors on;
        error_page 404 = @store_not_found;
    }
    
    location @store_not_found {
        root /var/www/celora/frontend/build;
        try_files /store-not-found.html /index.html;
    }
}

# =============================================================================
# SERVER BLOCK 3: Custom Domains (catch-all for verified merchant domains)
# Handles: www.customstore.com - store storefronts
#          www.customstore.com/cpanel - merchant control panel
# =============================================================================
server {
    listen 80 default_server;
    server_name _;
    
    root /var/www/celora/frontend/build;
    index index.html;
    
    # =========================================================================
    # /cpanel ROUTE - Serve React app for merchant control panel
    # This allows merchants to access their dashboard from their custom domain!
    # Example: www.toolsinabox.com.au/cpanel
    # =========================================================================
    location /cpanel {
        # Serve React app for /cpanel routes
        # The React app detects it's on a custom domain and handles accordingly
        try_files $uri $uri/ /index.html;
    }
    
    # API routes to backend (with custom domain header)
    location /api/ {
        proxy_pass http://celora_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Custom-Domain $host;
    }
    
    # Uploaded files
    location /api/uploads/ {
        proxy_pass http://celora_backend;
    }
    
    # =========================================================================
    # STOREFRONT - Theme-rendered store pages via backend
    # =========================================================================
    location / {
        # Proxy to backend for storefront rendering
        # Backend will lookup store by custom_domain from Host header
        proxy_pass http://celora_backend/api/maropost/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Custom-Domain $host;
        
        # Error handling for non-existent stores
        proxy_intercept_errors on;
        error_page 404 = @store_not_found;
    }
    
    location @store_not_found {
        root /var/www/celora/frontend/build;
        try_files /store-not-found.html /index.html;
    }
}

# =============================================================================
# NOTES FOR SSL SETUP:
# =============================================================================
# For main domain + subdomains:
#   sudo certbot --nginx -d getcelora.com -d www.getcelora.com -d "*.getcelora.com"
#
# For each custom domain (manually):
#   sudo certbot --nginx -d www.customstore.com
#
# The wildcard cert (*.getcelora.com) requires DNS challenge:
#   sudo certbot certonly --manual --preferred-challenges dns -d "*.getcelora.com"
# =============================================================================
