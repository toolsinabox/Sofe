# =============================================================================
# Celora Nginx Configuration for VPS
# =============================================================================
# Deploy: Copy to /etc/nginx/sites-available/celora
# Enable: sudo ln -sf /etc/nginx/sites-available/celora /etc/nginx/sites-enabled/
# Reload: sudo nginx -t && sudo systemctl reload nginx
# =============================================================================

upstream celora_backend {
    server 127.0.0.1:8001;
}

# =============================================================================
# Main Platform (getcelora.com / www.getcelora.com)
# Serves: Platform landing, admin dashboard, merchant portal
# =============================================================================
server {
    listen 80;
    server_name getcelora.com www.getcelora.com;

    root /var/www/celora/frontend/build;
    index index.html;

    # API routes to backend
    location /api/ {
        proxy_pass http://celora_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # React app - all routes go to index.html
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# =============================================================================
# Subdomains (*.getcelora.com)
# Serves: Store frontends + /cpanel merchant dashboard
# =============================================================================
server {
    listen 80;
    server_name *.getcelora.com;

    root /var/www/celora/frontend/build;
    index index.html;

    # Static assets for React app (JS, CSS, images)
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Manifest and other root static files
    location ~* \.(json|ico|png|txt|xml)$ {
        try_files $uri =404;
    }

    # API routes to backend
    location /api/ {
        proxy_pass http://celora_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /cpanel routes - SERVE REACT APP (not proxy to backend)
    # This is the merchant control panel
    location ^~ /cpanel {
        try_files $uri /index.html;
    }

    # /_cpanel routes (legacy) - SERVE REACT APP  
    location ^~ /_cpanel {
        try_files $uri /index.html;
    }

    # /merchant routes - SERVE REACT APP
    location ^~ /merchant {
        try_files $uri /index.html;
    }

    # All other routes - Proxy to backend for storefront rendering
    # Backend returns themed HTML pages
    location / {
        proxy_pass http://celora_backend/api/maropost/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =============================================================================
# Custom Domains (merchants' own domains like mystore.com)
# Same behavior as subdomains
# =============================================================================
server {
    listen 80 default_server;
    server_name _;

    root /var/www/celora/frontend/build;
    index index.html;

    # Static assets
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    location ~* \.(json|ico|png|txt|xml)$ {
        try_files $uri =404;
    }

    # API routes
    location /api/ {
        proxy_pass http://celora_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /cpanel - Merchant control panel (React app)
    location ^~ /cpanel {
        try_files $uri /index.html;
    }

    location ^~ /_cpanel {
        try_files $uri /index.html;
    }

    location ^~ /merchant {
        try_files $uri /index.html;
    }

    # Storefront - proxy to backend
    location / {
        proxy_pass http://celora_backend/api/maropost/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
